# Sistema de Tracking de Correos Enviados - Documentaci√≥n T√©cnica Completa

## Resumen Ejecutivo

Se implement√≥ un sistema completo de **tracking de correos enviados** que se asocia autom√°ticamente con clientes, reservas y presupuestos, proporcionando un historial completo de comunicaciones para mejorar el servicio al cliente.

## üéØ Objetivos Principales

1. **Historial Completo**: Registrar todos los correos enviados a clientes
2. **Asociaci√≥n Autom√°tica**: Vincular correos con clientes, reservas y presupuestos
3. **Estad√≠sticas de Comunicaci√≥n**: M√©tricas de env√≠o, entrega y apertura
4. **Resumen por Cliente**: Historial unificado de comunicaciones
5. **An√°lisis de Engagement**: Tasas de respuesta y tiempo de respuesta

## üóÇÔ∏è Arquitectura de Base de Datos

### Tabla Principal: `SentEmailTracking`

```sql
CREATE TABLE "SentEmailTracking" (
    "id" BIGSERIAL PRIMARY KEY,
    "clientId" BIGINT REFERENCES "Client"("id") ON DELETE CASCADE,
    "reservationId" BIGINT REFERENCES "reservations"("id") ON DELETE SET NULL,
    "budgetId" BIGINT REFERENCES "sales_quote"("id") ON DELETE SET NULL,
    "recipientEmail" TEXT NOT NULL,
    "recipientName" TEXT,
    "senderEmail" TEXT NOT NULL,
    "senderName" TEXT,
    "subject" TEXT NOT NULL,
    "body" TEXT,
    "emailType" TEXT NOT NULL, -- 'confirmation', 'reminder', 'payment_request', 'follow_up', 'marketing', 'custom'
    "status" TEXT NOT NULL DEFAULT 'sent', -- 'sent', 'delivered', 'opened', 'clicked', 'bounced', 'failed'
    "isAutomated" BOOLEAN DEFAULT false,
    "templateUsed" TEXT,
    "attachments" JSONB,
    "metadata" JSONB,
    "sentAt" TIMESTAMPTZ DEFAULT NOW(),
    "deliveredAt" TIMESTAMPTZ,
    "openedAt" TIMESTAMPTZ,
    "clickedAt" TIMESTAMPTZ,
    "createdAt" TIMESTAMPTZ DEFAULT NOW(),
    "updatedAt" TIMESTAMPTZ DEFAULT NOW()
);
```

### Tabla de Resumen: `ClientCommunicationSummary`

```sql
CREATE TABLE "ClientCommunicationSummary" (
    "id" BIGSERIAL PRIMARY KEY,
    "clientId" BIGINT NOT NULL REFERENCES "Client"("id") ON DELETE CASCADE,
    "totalEmailsSent" INTEGER DEFAULT 0,
    "totalEmailsReceived" INTEGER DEFAULT 0,
    "lastEmailSent" TIMESTAMPTZ,
    "lastEmailReceived" TIMESTAMPTZ,
    "totalReservationEmails" INTEGER DEFAULT 0,
    "totalBudgetEmails" INTEGER DEFAULT 0,
    "totalPaymentEmails" INTEGER DEFAULT 0,
    "communicationScore" INTEGER DEFAULT 0, -- 1-10 basado en frecuencia y respuesta
    "preferredContactMethod" TEXT, -- 'email', 'phone', 'whatsapp'
    "responseRate" DECIMAL(5,2) DEFAULT 0, -- Porcentaje de emails que reciben respuesta
    "avgResponseTime" INTERVAL, -- Tiempo promedio de respuesta
    "createdAt" TIMESTAMPTZ DEFAULT NOW(),
    "updatedAt" TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE("clientId")
);
```

## üîß Funciones SQL Principales

### 1. Registrar Correo Enviado

```sql
CREATE OR REPLACE FUNCTION track_sent_email(
    p_client_id BIGINT,
    p_recipient_email TEXT,
    p_recipient_name TEXT DEFAULT NULL,
    p_sender_email TEXT DEFAULT 'info@admintermas.com',
    p_sender_name TEXT DEFAULT 'Hotel Termas Llif√©n',
    p_subject TEXT DEFAULT '',
    p_body TEXT DEFAULT '',
    p_email_type TEXT DEFAULT 'custom',
    p_reservation_id BIGINT DEFAULT NULL,
    p_budget_id BIGINT DEFAULT NULL,
    p_template_used TEXT DEFAULT NULL,
    p_is_automated BOOLEAN DEFAULT false,
    p_attachments JSONB DEFAULT NULL,
    p_metadata JSONB DEFAULT NULL
) RETURNS JSON;
```

### 2. Obtener Resumen de Comunicaciones

```sql
CREATE OR REPLACE FUNCTION get_client_communication_summary(p_client_id BIGINT)
RETURNS JSON;
```

### 3. Estad√≠sticas Globales

```sql
CREATE OR REPLACE FUNCTION get_sent_emails_stats(p_days INTEGER DEFAULT 30)
RETURNS JSON;
```

## üìß Tipos de Correos Soportados

| Tipo | Descripci√≥n | Icono | Uso |
|------|-------------|-------|-----|
| `confirmation` | Confirmaci√≥n de reserva | ‚úÖ | Reservas confirmadas |
| `reminder` | Recordatorio | ‚è∞ | Recordatorios de check-in/pago |
| `payment_request` | Solicitud de pago | üí∞ | Solicitudes de pago pendiente |
| `follow_up` | Seguimiento | üìû | Seguimiento post-estad√≠a |
| `marketing` | Marketing | üì¢ | Promociones y ofertas |
| `custom` | Personalizado | üìß | Correos personalizados |

## üöÄ Server Actions

### Archivo: `src/actions/emails/sent-email-actions.ts`

#### Principales Funciones:

1. **`trackSentEmail(emailData: SentEmailData)`**
   - Registra un correo enviado
   - Actualiza autom√°ticamente el resumen del cliente
   - Retorna confirmaci√≥n de √©xito

2. **`getClientCommunicationSummary(clientId: number)`**
   - Obtiene resumen completo de comunicaciones
   - Incluye correos enviados y recibidos
   - Calcula m√©tricas de engagement

3. **`getSentEmailsStats(days: number)`**
   - Estad√≠sticas globales de correos enviados
   - Breakdown por tipo y estado
   - Actividad reciente

4. **`getRecentSentEmails(limit: number)`**
   - Lista de correos enviados recientes
   - Incluye informaci√≥n del cliente
   - Ordenados por fecha

5. **`updateSentEmailStatus(emailId: number, status: string)`**
   - Actualiza estado del correo
   - Marcas de tiempo autom√°ticas
   - Estados: delivered, opened, clicked, bounced, failed

## üé® Componentes Frontend

### 1. SentEmailsSummary.tsx

**Caracter√≠sticas:**
- Estad√≠sticas visuales de correos enviados
- Lista de correos recientes con estado
- Breakdown por tipo de correo
- M√©tricas de entrega y apertura

**Props:**
```typescript
interface SentEmailsSummaryProps {
  showRecent?: boolean;
  maxResults?: number;
}
```

### 2. SendEmailForm.tsx

**Caracter√≠sticas:**
- Formulario para registrar correos enviados manualmente
- Selecci√≥n de tipo de correo
- Asociaci√≥n autom√°tica con cliente/reserva/presupuesto
- Validaciones y feedback

**Props:**
```typescript
interface SendEmailFormProps {
  clientId?: number;
  clientEmail?: string;
  clientName?: string;
  reservationId?: number;
  budgetId?: number;
  onSuccess?: () => void;
  onCancel?: () => void;
}
```

## üîå APIs REST

### 1. GET `/api/emails/sent-emails`

**Par√°metros:**
- `limit` (opcional): N√∫mero m√°ximo de emails a retornar

**Respuesta:**
```json
{
  "success": true,
  "emails": [...],
  "total": 25
}
```

### 2. GET `/api/emails/sent-emails-stats`

**Par√°metros:**
- `days` (opcional): N√∫mero de d√≠as para estad√≠sticas (default: 30)

**Respuesta:**
```json
{
  "success": true,
  "stats": {
    "totalSent": 150,
    "byType": {
      "confirmation": 45,
      "payment_request": 30,
      "follow_up": 25
    },
    "byStatus": {
      "sent": 120,
      "delivered": 100,
      "opened": 75
    }
  }
}
```

## üîÑ Estados de Correos

| Estado | Descripci√≥n | Badge Color |
|--------|-------------|-------------|
| `sent` | Enviado | Azul |
| `delivered` | Entregado | Verde |
| `opened` | Abierto/Le√≠do | P√∫rpura |
| `clicked` | Click en enlace | Naranja |
| `bounced` | Rebotado | Rojo |
| `failed` | Fallido | Rojo |

## üìä M√©tricas y An√°lisis

### M√©tricas por Cliente:
- **Total de correos enviados/recibidos**
- **Fecha del √∫ltimo correo enviado/recibido**
- **Correos por categor√≠a** (reservas, presupuestos, pagos)
- **Tasa de respuesta** (% de emails que reciben respuesta)
- **Tiempo promedio de respuesta**
- **Puntuaci√≥n de comunicaci√≥n** (1-10)

### M√©tricas Globales:
- **Correos enviados por per√≠odo**
- **Breakdown por tipo de correo**
- **Tasas de entrega y apertura**
- **Actividad reciente**

## üîó Integraci√≥n con Sistema Existente

### Con M√≥dulo de Correos Recibidos:
- **Trigger autom√°tico**: Actualiza resumen cuando llegan correos
- **Historial unificado**: Combina enviados + recibidos
- **Identificaci√≥n de clientes**: Asocia autom√°ticamente

### Con M√≥dulo de Reservas:
- **Registro autom√°tico**: Al enviar confirmaciones
- **Asociaci√≥n directa**: `reservationId` en el correo
- **Seguimiento completo**: Todo el flujo de comunicaci√≥n

### Con M√≥dulo de Presupuestos:
- **Tracking de cotizaciones**: Env√≠o de presupuestos
- **Seguimiento de ventas**: Correos de seguimiento
- **Asociaci√≥n directa**: `budgetId` en el correo

## üì± Interfaz de Usuario

### Dashboard Principal:
1. **Estad√≠sticas r√°pidas**:
   - Total enviados √∫ltimos 30 d√≠as
   - Correos entregados/abiertos
   - Confirmaciones enviadas

2. **Lista de correos recientes**:
   - Informaci√≥n del cliente
   - Tipo de correo con icono
   - Estado con badge colorido
   - Fecha y hora de env√≠o

3. **Breakdown por tipo**:
   - Gr√°fico visual de tipos
   - Contadores por categor√≠a

### Formulario de Registro:
1. **Informaci√≥n del destinatario**:
   - Email del cliente (requerido)
   - Nombre del cliente

2. **Detalles del correo**:
   - Tipo de correo (selector)
   - Asunto (requerido)
   - Contenido (opcional)
   - Template utilizado

3. **Asociaciones autom√°ticas**:
   - Cliente ID
   - Reserva ID (si aplica)
   - Presupuesto ID (si aplica)

## üéõÔ∏è Configuraci√≥n y Personalizaci√≥n

### Variables de Entorno:
```env
# Default para correos enviados
DEFAULT_SENDER_EMAIL=info@admintermas.com
DEFAULT_SENDER_NAME=Hotel Termas Llif√©n
```

### Configuraci√≥n de Templates:
```typescript
const emailTypes = [
  { value: 'confirmation', label: 'Confirmaci√≥n de Reserva', icon: '‚úÖ' },
  { value: 'reminder', label: 'Recordatorio', icon: '‚è∞' },
  { value: 'payment_request', label: 'Solicitud de Pago', icon: 'üí∞' },
  { value: 'follow_up', label: 'Seguimiento', icon: 'üìû' },
  { value: 'marketing', label: 'Marketing', icon: 'üì¢' },
  { value: 'custom', label: 'Personalizado', icon: 'üìß' }
];
```

## üîê Seguridad y Permisos

### Pol√≠ticas RLS:
- **Tabla SentEmailTracking**: Acceso completo para authenticated
- **Tabla ClientCommunicationSummary**: Acceso completo para authenticated
- **Service Role**: Permisos completos para funciones automatizadas

### Validaciones:
- **Cliente requerido**: No se puede registrar correo sin cliente
- **Email v√°lido**: Validaci√≥n de formato de email
- **Asunto requerido**: Obligatorio para tracking

## üìà Beneficios del Sistema

### Para el Negocio:
1. **Historial completo**: Nunca perder track de comunicaciones
2. **Mejor servicio**: Conocer todo el historial al atender clientes
3. **M√©tricas de comunicaci√≥n**: Analizar efectividad de correos
4. **Seguimiento de ventas**: Track completo del proceso de venta

### Para el Personal:
1. **Contexto completo**: Ver todas las comunicaciones previas
2. **Seguimiento autom√°tico**: No olvidar seguimientos importantes
3. **M√©tricas personales**: Ver efectividad de comunicaciones
4. **Automatizaci√≥n**: Registros autom√°ticos cuando sea posible

### Para los Clientes:
1. **Comunicaci√≥n coherente**: Evitar repetir informaci√≥n
2. **Respuestas r√°pidas**: Personal informado del historial
3. **Seguimiento proactivo**: Recordatorios y seguimientos oportunos

## üöÄ Implementaci√≥n y Testing

### Migraci√≥n SQL:
```bash
# Aplicar migraci√≥n
supabase migration up 20250118000002_create_sent_emails_tracking
```

### Testing Manual:
1. **Registrar correo enviado**:
   ```typescript
   await trackSentEmail({
     clientId: 1,
     recipientEmail: 'cliente@email.com',
     subject: 'Confirmaci√≥n de Reserva',
     emailType: 'confirmation'
   });
   ```

2. **Verificar resumen**:
   ```typescript
   const summary = await getClientCommunicationSummary(1);
   console.log(summary.summary.totalEmailsSent); // Debe incrementar
   ```

3. **Comprobar estad√≠sticas**:
   ```typescript
   const stats = await getSentEmailsStats(30);
   console.log(stats.totalSent); // Debe incluir nuevo correo
   ```

## üìù Casos de Uso Reales

### 1. Confirmaci√≥n de Reserva:
```typescript
// Al confirmar una reserva
await trackSentEmail({
  clientId: reserva.clientId,
  reservationId: reserva.id,
  recipientEmail: cliente.email,
  subject: `Confirmaci√≥n de Reserva #${reserva.id}`,
  emailType: 'confirmation',
  templateUsed: 'reservation_confirmation',
  isAutomated: true
});
```

### 2. Seguimiento de Presupuesto:
```typescript
// Al enviar presupuesto
await trackSentEmail({
  clientId: presupuesto.clientId,
  budgetId: presupuesto.id,
  recipientEmail: cliente.email,
  subject: `Presupuesto #${presupuesto.number}`,
  emailType: 'custom',
  body: 'Presupuesto detallado adjunto'
});
```

### 3. Recordatorio de Pago:
```typescript
// Recordatorio autom√°tico
await trackSentEmail({
  clientId: cliente.id,
  reservationId: reserva.id,
  recipientEmail: cliente.email,
  subject: 'Recordatorio de Pago - Reserva Pendiente',
  emailType: 'payment_request',
  isAutomated: true
});
```

## üîÆ Roadmap Futuro

### Fase 1 (Actual):
- ‚úÖ Tracking b√°sico de correos enviados
- ‚úÖ Asociaci√≥n con clientes/reservas/presupuestos
- ‚úÖ Estad√≠sticas b√°sicas
- ‚úÖ Interfaz de usuario

### Fase 2 (Pr√≥ximo):
- üìß Integraci√≥n con servicios de email (SendGrid, Mailgun)
- üìä Webhooks para tracking autom√°tico de estados
- ü§ñ Templates de correo autom√°ticos
- üìà Analytics avanzados

### Fase 3 (Futuro):
- üéØ Segmentaci√≥n de clientes por comunicaci√≥n
- üîÑ Campaigns de email marketing
- üì± Notificaciones push
- ü§ñ IA para optimizaci√≥n de subject lines

## üìû Soporte y Mantenimiento

### Logs y Debugging:
- Todos los server actions incluyen logging detallado
- Console.log para debugging en desarrollo
- Error handling robusto con mensajes descriptivos

### Monitoreo:
- Verificar crecimiento de tabla `SentEmailTracking`
- Monitorear performance de consultas
- Revisar logs de errores en funciones SQL

### Backup y Recuperaci√≥n:
- Incluir tablas en backup regular de Supabase
- Pol√≠ticas de retenci√≥n de datos
- Procedimientos de recuperaci√≥n

---

## ‚úÖ Estado del Sistema

**‚úÖ SISTEMA 100% FUNCIONAL**

- Migraci√≥n SQL aplicada exitosamente
- Server actions implementadas y testeadas
- Componentes frontend completamente funcionales
- APIs REST operativas
- Integraci√≥n con dashboard principal
- Documentaci√≥n completa

**Listo para uso en producci√≥n** - El sistema registrar√° autom√°ticamente correos enviados y mantendr√° un historial completo de comunicaciones con clientes para optimizar el servicio al cliente del Hotel Termas Llif√©n. 